<!DOCTYPE html>
<html lang="english">
<head>
          <title>Jack McKew's Blog - Portfolio Balancing with Historical Stock Data</title>
        <meta charset="utf-8" />




    <meta name="tags" content="finance" />
    <meta name="tags" content="python" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://jackmckew.dev/">Jack McKew's Blog <strong>Python enthusiast, electrical engineer and tinkerer</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/archives.html">Archives</a></li>
            <li><a href="/categories.html">Categories</a></li>
            <li><a href="/tags.html">Tags</a></li>
            <li><a href="/sitemap.xml">Sitemap</a></li>
            <li><a href="https://jackmckew.dev/pages/contact.html">Contact</a></li>
            <li><a href="https://jackmckew.dev/pages/cv-professional.html">CV/Professional</a></li>
            <li><a href="https://jackmckew.dev/category/android.html">Android</a></li>
            <li><a href="https://jackmckew.dev/category/book-reviews.html">Book Reviews</a></li>
            <li><a href="https://jackmckew.dev/category/data-science.html">Data Science</a></li>
            <li><a href="https://jackmckew.dev/category/engineering.html">Engineering</a></li>
            <li><a href="https://jackmckew.dev/category/engineering-python.html">Engineering, Python</a></li>
            <li><a href="https://jackmckew.dev/category/machine-learning.html">Machine Learning</a></li>
            <li><a href="https://jackmckew.dev/category/principles.html">Principles</a></li>
            <li><a href="https://jackmckew.dev/category/python.html">Python</a></li>
            <li class="active"><a href="https://jackmckew.dev/category/python-data-science.html">Python, Data Science</a></li>
            <li><a href="https://jackmckew.dev/category/python-engineering.html">Python, Engineering</a></li>
            <li><a href="https://jackmckew.dev/category/python-principles.html">Python, Principles</a></li>
            <li><a href="https://jackmckew.dev/category/software-development.html">Software Development</a></li>
            <li><a href="https://jackmckew.dev/category/software-development-data-science.html">Software Development, Data Science</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://jackmckew.dev/portfolio-balancing-with-historical-stock-data.html" rel="bookmark"
         title="Permalink to Portfolio Balancing with Historical Stock Data">Portfolio Balancing with Historical Stock Data</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-04-19T06:30:00+10:00">
      Fri 19 April 2019
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://jackmckew.dev/author/jack-mckew.html">Jack McKew</a>
    </address>
    <div class="category">
        Category: <a href="https://jackmckew.dev/category/python-data-science.html">Python, Data Science</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://jackmckew.dev/tag/finance.html">finance</a>
            <a href="https://jackmckew.dev/tag/python.html">python</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Following last weeks' post (<a href="https://jmckew.com/2019/04/12/python-for-the-finance-industry/">Python for the Finance Industry</a>). This post is to demonstrate a method of determining an optimized portfolio based on historical stock price data.</p>
<p>First of all while attempting to tackle this problem, I stumbled across many very informative articles in which based on what I learned throughout reading them, and trying to replicate their findings with the ASX stocks' data.</p>
<ul>
<li>Ricky Kim (<a href="https://towardsdatascience.com/efficient-frontier-portfolio-optimisation-in-python-e7844051e7f">Efficient Frontier Portfolio Optimisation in Python)</a></li>
<li>Bernard Brenyah (<a href="https://medium.com/python-data/effient-frontier-in-python-34b0c3043314">Markowitz’s Efficient Frontier in Python)</a></li>
</ul>
<p>Now I will not be going into how Markowit'z Efficient Frontier Portfolio Optimization &amp; Sharpe Ratios works as these techniques are extremely well documented across this internet and very easily found. This post will be for implementing these techniques in Python to apply them to an ASX based portfolio.</p>
<p>Picking up from the end of the previous post, we had just plotted the percentage change over the time period for our stocks' data. For the sake of this post we will be using a technique called random optimization, where will be taking a number of random attempts and selecting the best one. Further posts will show a more detailed approach to this optimization problem.</p>
<p>Now there are multiple steps before we get to the desired outcome of a balanced portfolio.</p>
<ol>
<li>Generate X number of 'random' portfolios,</li>
<li>Rate their performance against one another,</li>
<li>Pick the desired solution.</li>
</ol>
<p>To generate random portfolios, we define a function such that we can pass it differing variables as to tweak our outcomes in the future.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">generate_portfolios</span><span class="p">(</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">):</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="n">num_portfolios</span><span class="p">))</span>
    <span class="n">weights_record</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">portfolio</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_portfolios</span><span class="p">):</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">companies</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">weights_record</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">returns</span><span class="p">,</span> <span class="n">volatility</span> <span class="o">=</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">portfolio</span><span class="p">]</span> <span class="o">=</span> <span class="n">volatility</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">portfolio</span><span class="p">]</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="n">portfolio</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">returns</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">volatility</span>
    <span class="k">return</span> <span class="n">results</span><span class="p">,</span> <span class="n">weights_record</span>
</pre></div>
</td></tr></table>

<p>To step through this function:</p>
<ol>
<li>Define empty location for our portfolio performance results to be stored along with recording weights so we can extract them once selected,</li>
<li>For each portfolio to be generated, give a random 'weighting' for each of the company that we have historical data on (eg, 23% NAB.AX),</li>
<li>Even out the distribution of the weights such that the sum of the weightings is 100% (eg, total budget),</li>
<li>Record the weightings generated in our memory location,</li>
<li>Determine the performance of our randomly generated portfolio (more on that soon),</li>
<li>Fill in the portfolio performance results for this generated portfolio and repeat for X number of portfolios.</li>
</ol>
<p>In step 5 above, we have to determine how to rank the generated portfolios against each other to work out how to filter our results. To do this, we calculate volatility of the portfolio using the following formula:</p>
<p><img alt="\
Assessing the riskiness of a portfolio with Python" src="https://cdn-images-1.medium.com/max/1600/1*IabrYvsgHE07z2CJwoE9Zw.jpeg"></p>
<p><a href="https://medium.com/@bbrenyah">Bernard Brenyah</a>, whom I mentioned at the beginning of the post, has provided a clear explanation of how the above formula can be expressed in matrix calculation in one of <a href="https://medium.com/python-data/assessing-risks-and-return-with-probabilities-of-events-with-python-c564d9be4db4">his blog post</a>s. In which we just take the matrix calculation and multiply by 253 for number of trading days in Australia.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">portfolio_performance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">):</span>
    <span class="n">returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="o">*</span><span class="n">average_returns</span><span class="p">)</span> <span class="o">*</span> <span class="mi">253</span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">weights</span><span class="p">))</span>
    <span class="n">volatility</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">253</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">returns</span><span class="p">,</span> <span class="n">volatility</span>
</pre></div>
</td></tr></table>

<p>Now that we have X number of randomly generated portfolios, all ranked against one another, it's time to plot so that our results can be visualized.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_random_efficient_frontier</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">):</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">generate_portfolios</span><span class="p">(</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>

    <span class="n">max_sharpe_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">max_volatility</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">max_sharpe_index</span><span class="p">]</span>
    <span class="n">max_return</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">max_sharpe_index</span><span class="p">]</span>
    <span class="n">max_sharpe_allocations</span> <span class="o">=</span> <span class="n">allocations</span><span class="p">(</span><span class="n">max_sharpe_index</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;MAX SHARPE RATIO</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Return: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_return</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Volatility: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_volatility</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">max_sharpe_allocations</span><span class="p">)</span>

    <span class="n">min_vol_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">min_volatility</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="n">min_vol_index</span><span class="p">]</span>
    <span class="n">min_return</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="n">min_vol_index</span><span class="p">]</span>
    <span class="n">min_vol_allocations</span> <span class="o">=</span> <span class="n">allocations</span><span class="p">(</span><span class="n">min_vol_index</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MINIMUM VOLATILITY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Return: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_return</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Volatility: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_volatility</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">min_vol_allocations</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">c</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">max_volatility</span><span class="p">,</span><span class="n">max_return</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe ratio&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">min_volatility</span><span class="p">,</span><span class="n">min_return</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum volatility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Simulated Portfolio Optimization based on Efficient Frontier&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">allocations</span><span class="p">(</span><span class="n">index</span><span class="p">,</span><span class="n">weights</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">):</span>
    <span class="n">allocation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">weights</span><span class="p">[</span><span class="n">index</span><span class="p">],</span><span class="n">index</span><span class="o">=</span><span class="n">stocks_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">allocation</span>
</pre></div>
</td></tr></table>

<p>Using the above function 'display_random_efficient_frontier', this will determine our max sharpe ratio portfolio generated and the minimum volatility portfolio with their respective returns. Now it is entirely up to the trader on how much risk they are willing to take on board with their portfolio. With the settings below in conjunction with the previously defined functions and stock data to generate the portfolios (risk free rate determined from <a href="http://www.worldgovernmentbonds.com/country/australia/">this website</a>).</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">returns</span> <span class="o">=</span> <span class="n">stocks_df</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">mean_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">cov_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">num_portfolios</span> <span class="o">=</span> <span class="mi">25000</span>
<span class="n">risk_free_rate</span> <span class="o">=</span> <span class="mf">0.01977</span>

<span class="n">display_random_efficient_frontier</span><span class="p">(</span><span class="n">mean_returns</span><span class="p">,</span><span class="n">cov_matrix</span><span class="p">,</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p><img alt="sharpe_ratios" src="..\img\portfolio-balancing-with-historical-stock-data\image-12.png"></p>
<p><img alt="efficient_frontier" src="..\img\efficient-frontier-for-balancing-portfolios\image-20.png"></p>
<p>With the two portfolios determined, the one gives us the best risk-adjusted (as long as the trader is prepared to take the risk) is the one with the maximum Sharpe ratio, allocating a 67% portion to WOW and 32% to BHP, as these stocks were quite volatile from the daily percentage change calculations.</p>
<p>On the other hand, the minimum volatility portfolio is reflecting the more stable of the stocks from the daily percentage change calculations distributing portions over NAB and TLS due to their stability from the percentage change calculations and reducing the portion to WOW.</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>