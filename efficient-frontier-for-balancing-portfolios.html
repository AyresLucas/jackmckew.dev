<!DOCTYPE html>
<html lang="english">
<head>
          <title>Jack McKew's Blog - Efficient Frontier for Balancing Portfolios</title>
        <meta charset="utf-8" />




    <meta name="tags" content="python" />
    <meta name="tags" content="data" />
    <meta name="tags" content="analysis" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://jackmckew.dev/">Jack McKew's Blog <strong>Python enthusiast, electrical engineer and tinkerer</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/archives.html">Archives</a></li>
            <li><a href="/categories.html">Categories</a></li>
            <li><a href="/tags.html">Tags</a></li>
            <li><a href="/sitemap.xml">Sitemap</a></li>
            <li><a href="https://jackmckew.dev/pages/contact.html">Contact</a></li>
            <li><a href="https://jackmckew.dev/pages/cv-professional.html">CV/Professional</a></li>
            <li><a href="https://jackmckew.dev/category/android.html">Android</a></li>
            <li><a href="https://jackmckew.dev/category/book-reviews.html">Book Reviews</a></li>
            <li><a href="https://jackmckew.dev/category/data-science.html">Data Science</a></li>
            <li><a href="https://jackmckew.dev/category/engineering.html">Engineering</a></li>
            <li><a href="https://jackmckew.dev/category/engineering-python.html">Engineering, Python</a></li>
            <li><a href="https://jackmckew.dev/category/machine-learning.html">Machine Learning</a></li>
            <li><a href="https://jackmckew.dev/category/principles.html">Principles</a></li>
            <li><a href="https://jackmckew.dev/category/python.html">Python</a></li>
            <li class="active"><a href="https://jackmckew.dev/category/python-data-science.html">Python, Data Science</a></li>
            <li><a href="https://jackmckew.dev/category/python-engineering.html">Python, Engineering</a></li>
            <li><a href="https://jackmckew.dev/category/python-principles.html">Python, Principles</a></li>
            <li><a href="https://jackmckew.dev/category/software-development.html">Software Development</a></li>
            <li><a href="https://jackmckew.dev/category/software-development-data-science.html">Software Development, Data Science</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://jackmckew.dev/efficient-frontier-for-balancing-portfolios.html" rel="bookmark"
         title="Permalink to Efficient Frontier for Balancing Portfolios">Efficient Frontier for Balancing Portfolios</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-04-26T06:30:00+10:00">
      Fri 26 April 2019
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://jackmckew.dev/author/admin.html">admin</a>
    </address>
    <div class="category">
        Category: <a href="https://jackmckew.dev/category/python-data-science.html">Python, Data Science</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://jackmckew.dev/tag/python.html">python</a>
            <a href="https://jackmckew.dev/tag/data.html">data</a>
            <a href="https://jackmckew.dev/tag/analysis.html">analysis</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Following last 2 weeksâ€™ posts (<a href="https://jmckew.com/2019/04/12/python-for-the-finance-industry/">Python for the Finance Industry</a> &amp; <a href="https://jmckew.com/2019/04/19/portfolio-balancing-with-historical-stock-data/">Portfolio Balancing with Historical Stock Data</a>), we now know how to extract historical records on stock information from the ASX through an API, present it in a graph using matplotlib, and how to balance a portfolio using randomly generated portfolios.</p>
<p>This post is to demonstrate a method in balancing portfolios that does not depend on generating random portfolios, but rather mathematically determining the extremities of boundaries for effective portfolios using the <a href="https://docs.scipy.org/doc/scipy/reference/tutorial/optimize.html">SciPy optimize function</a> (similar to that of <a href="https://support.office.com/en-ie/article/define-and-solve-a-problem-by-using-solver-5d1a388f-079d-43ac-a7eb-f63e45925040">Excel's 'solver'</a>).</p>
<p>Returning to last weeks' post when the budget allocations to assets were determined from randomly generated portfolios, it was presented on the graph below:</p>
<p><img alt="image-20" src="..\img\efficient-frontier-for-balancing-portfolios\image-20.png"></p>
<p>From this plot, it can be visualized that it forms an arch line between the yellow and red crosses. This line is called the <a href="https://www.investopedia.com/terms/e/efficientfrontier.asp">efficient frontier</a>. The efficient frontier represents the set of optimal portfolios that offer the highest expected return for a defined level of risk or the lowest risk for a given level of expected return. Simply this means, all the dots (portfolios) to the right of the line will give you a higher risk for the same returns.</p>
<p>First of all we must mathematically determine the portfolio with the maximum Sharpe ratio as the greater a portfolio's Sharpe ratio, the better it's risk-adjusted performance. Sharpe ratio is calculated using the formula below:</p>
<p><img alt="" src="..\img\efficient-frontier-for-balancing-portfolios\chrome_dUqVqnTloj.png"></p>
<p>To find the maximum of the Sharpe Ratio programmatically we follow these steps:</p>
<ul>
<li>Firstly, define the formula as the function neg_sharpe_ratio (take note that to find the <a href="https://docs.scipy.org/doc/scipy/reference/tutorial/optimize.html#constrained-minimization-of-multivariate-scalar-functions-minimize">maximum of function in SciPy</a>, we use the minimize function with an inverse sign),</li>
<li>In the max_sharpe_ratio function, define arguments to be passed into the SciPy minimize function:<ul>
<li>neg_sharpe_ratio: function to be minimized,</li>
<li>num*[1/num_assets]: initial guess which is evenly distributed array of values,</li>
<li>Arguments that are to be passed into the objective function (neg_sharpe_ratio),</li>
<li>Method of Sequential Lease Squares Programming, there are <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html">many others which can be seen here,</a></li>
<li>Bounds: between 0% and 100% of our budget allocation,</li>
<li>Constraints: given as a dictionary, 'eq' type for equality and 'fun' for the anonymous function which limits the total summed asset allocation to 100% of the budget.</li>
</ul>
</li>
<li>The result from the minimize function is returned as a <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.OptimizeResult.html#scipy.optimize.OptimizeResult">OptimizeResult</a> type.</li>
</ul>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">neg_sharpe_ratio</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">):</span>
    <span class="n">returns</span><span class="p">,</span> <span class="n">volatility</span> <span class="o">=</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">returns</span> <span class="o">-</span> <span class="n">risk_free_rate</span><span class="p">)</span> <span class="o">/</span> <span class="n">volatility</span>

<span class="k">def</span> <span class="nf">max_sharpe_ratio</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">):</span>
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">average_returns</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">risk_free_rate</span><span class="p">)</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bound</span> <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">neg_sharpe_ratio</span><span class="p">,</span><span class="n">num_assets</span><span class="o">*</span><span class="p">[</span><span class="mi">1</span><span class="o">/</span><span class="n">num_assets</span><span class="p">,],</span><span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span><span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</td></tr></table>

<p>Similarly to the maximum sharpe ratio we do the same for determining the minimum volatility portfolio programmatically. We minimise volatility by trying different weightings on our asset allocations to find the minima.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">portfolio_volatility</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">min_variance</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">):</span>
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">average_returns</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">bound</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">)</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">bound</span> <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">))</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_volatility</span><span class="p">,</span> <span class="n">num_assets</span><span class="o">*</span><span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="n">num_assets</span><span class="p">,],</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</td></tr></table>

<p>As above, we can also draw a line which depicts the efficient frontier for the portfolios for a given risk rate. Below some functions are defined for computing the efficient frontier. The first function, efficient_return is calculating the most efficient portfolio for a given target return, and the second function efficient frontier is compiling the most efficient portfolio for a range of targets.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">efficient_return</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">target</span><span class="p">):</span>
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">average_returns</span><span class="p">)</span>
    <span class="n">args</span> <span class="o">=</span> <span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">portfolio_return</span><span class="p">(</span><span class="n">weights</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">({</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">portfolio_return</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">target</span><span class="p">},</span>
                   <span class="p">{</span><span class="s1">&#39;type&#39;</span><span class="p">:</span> <span class="s1">&#39;eq&#39;</span><span class="p">,</span> <span class="s1">&#39;fun&#39;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">})</span>
    <span class="n">bounds</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">asset</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">))</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">sco</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_volatility</span><span class="p">,</span> <span class="n">num_assets</span><span class="o">*</span><span class="p">[</span><span class="mf">1.</span><span class="o">/</span><span class="n">num_assets</span><span class="p">,],</span> <span class="n">args</span><span class="o">=</span><span class="n">args</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;SLSQP&#39;</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>


<span class="k">def</span> <span class="nf">efficient_frontier</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">returns_range</span><span class="p">):</span>
    <span class="n">efficients</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ret</span> <span class="ow">in</span> <span class="n">returns_range</span><span class="p">:</span>
        <span class="n">efficients</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">efficient_return</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">ret</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">efficients</span>
</pre></div>
</td></tr></table>

<p>Now it's time to plot the efficient frontier on the graph with the randomly selected portfolios to check if they have been calculated correctly. It is also an opportune time to check if the maximum Sharpe ratio and minimum volatility portfolios have been calculated correctly by comparing them to the previously randomly determined portfolios.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_efficient_frontier</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">):</span>
    <span class="n">results</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">generate_portfolios</span><span class="p">(</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>

    <span class="n">max_sharpe</span> <span class="o">=</span> <span class="n">max_sharpe_ratio</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>
    <span class="n">max_sharpe_return</span><span class="p">,</span> <span class="n">max_sharpe_volatility</span> <span class="o">=</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">max_sharpe</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">max_sharpe_allocations</span> <span class="o">=</span> <span class="n">allocations_ef</span><span class="p">(</span><span class="n">max_sharpe</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;MAX SHARPE RATIO</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Return: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_sharpe_return</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Volatility: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_sharpe_volatility</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">max_sharpe_allocations</span><span class="p">)</span>

    <span class="n">min_vol</span> <span class="o">=</span> <span class="n">min_variance</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">min_vol_return</span><span class="p">,</span> <span class="n">min_vol_volatility</span> <span class="o">=</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">min_vol</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">min_vol_allocations</span> <span class="o">=</span> <span class="n">allocations_ef</span><span class="p">(</span><span class="n">min_vol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MINIMUM VOLATILITY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Return: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_vol_return</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Volatility: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_vol_volatility</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">min_vol_allocations</span><span class="p">)</span>

    <span class="n">an_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">253</span><span class="p">)</span>
    <span class="n">an_rt</span> <span class="o">=</span> <span class="n">average_returns</span> <span class="o">*</span> <span class="mi">253</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stocks_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="s2">&quot;Annuaised return&quot;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">an_rt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span><span class="s2">&quot;, Annualised volatility:&quot;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">an_vol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">,:],</span><span class="n">results</span><span class="p">[</span><span class="mi">1</span><span class="p">,:],</span><span class="n">c</span><span class="o">=</span><span class="n">results</span><span class="p">[</span><span class="mi">2</span><span class="p">,:],</span><span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;YlGnBu&#39;</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">max_sharpe_volatility</span><span class="p">,</span><span class="n">max_sharpe_return</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe ratio&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">min_vol_volatility</span><span class="p">,</span><span class="n">min_vol_return</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum volatility&#39;</span><span class="p">)</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_vol_return</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">an_rt</span><span class="p">),</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">efficient_portfolios</span> <span class="o">=</span> <span class="n">efficient_frontier</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">efficient_portfolios</span><span class="p">],</span> <span class="n">target</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;efficient frontier&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Calculated Portfolio Optimization based on Efficient Frontier&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">allocations_ef</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">):</span>
    <span class="n">allocation</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">solution</span><span class="p">,</span><span class="n">index</span><span class="o">=</span><span class="n">stocks_df</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;allocation&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">allocation</span>

<span class="n">returns</span> <span class="o">=</span> <span class="n">stocks_df</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span>
<span class="n">average_returns</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">covariance_matrix</span> <span class="o">=</span> <span class="n">returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">num_portfolios</span> <span class="o">=</span> <span class="mi">25000</span>
<span class="n">risk_free_rate</span> <span class="o">=</span> <span class="mf">0.01977</span>

<span class="n">display_efficient_frontier</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">num_portfolios</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p><img alt="Code_lDUKAxc9JU" src="..\img\efficient-frontier-for-balancing-portfolios\Code_lDUKAxc9JU.png"></p>
<p><img alt="Code_R2bA54PriC" src="..\img\efficient-frontier-for-balancing-portfolios\Code_R2bA54PriC.png"></p>
<p>The surprising part is that the calculated result is very close to what we have previously simulated by picking from randomly generated portfolios. The slight differences in allocations between the simulated vs calculated are in most cases less than 1%, which shows how powerful randomly estimating calculations can be albeit sometimes not reliable in small sample spaces.</p>
<p>Rather than plotting every randomly generated portfolio, we can plot the individual stocks on the plot with the corresponding values of each stock's return and risk. This way we can compare how diversification is lowering the risk by optimizing the allocations.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">display_efficient_frontier_selected</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">):</span>

    <span class="n">max_sharpe</span> <span class="o">=</span> <span class="n">max_sharpe_ratio</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>
    <span class="n">max_sharpe_return</span><span class="p">,</span> <span class="n">max_sharpe_volatility</span> <span class="o">=</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">max_sharpe</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">max_sharpe_allocations</span> <span class="o">=</span> <span class="n">allocations_ef</span><span class="p">(</span><span class="n">max_sharpe</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;MAX SHARPE RATIO</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Return: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_sharpe_return</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Volatility: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">max_sharpe_volatility</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">max_sharpe_allocations</span><span class="p">)</span>

    <span class="n">min_vol</span> <span class="o">=</span> <span class="n">min_variance</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">min_vol_return</span><span class="p">,</span> <span class="n">min_vol_volatility</span> <span class="o">=</span> <span class="n">portfolio_performance</span><span class="p">(</span><span class="n">min_vol</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">)</span>
    <span class="n">min_vol_allocations</span> <span class="o">=</span> <span class="n">allocations_ef</span><span class="p">(</span><span class="n">min_vol</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">stocks_df</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>

    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">MINIMUM VOLATILITY</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Return: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_vol_return</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Volatility: {0:.2f}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">min_vol_volatility</span><span class="p">))</span>
    <span class="k">print</span><span class="p">(</span><span class="n">min_vol_allocations</span><span class="p">)</span>

    <span class="n">an_vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">253</span><span class="p">)</span>
    <span class="n">an_rt</span> <span class="o">=</span> <span class="n">average_returns</span> <span class="o">*</span> <span class="mi">253</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stocks_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span><span class="s2">&quot;:&quot;</span><span class="p">,</span><span class="s2">&quot;Annuaised return&quot;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">an_rt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">),</span><span class="s2">&quot;, Annualised volatility:&quot;</span><span class="p">,</span><span class="nb">round</span><span class="p">(</span><span class="n">an_vol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="mi">2</span><span class="p">))</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">an_vol</span><span class="p">,</span><span class="n">an_rt</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">txt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">stocks_df</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">txt</span><span class="p">,</span> <span class="p">(</span><span class="n">an_vol</span><span class="p">[</span><span class="n">i</span><span class="p">],</span><span class="n">an_rt</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">xytext</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">textcoords</span><span class="o">=</span><span class="s1">&#39;offset points&#39;</span><span class="p">)</span>


    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">max_sharpe_volatility</span><span class="p">,</span><span class="n">max_sharpe_return</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Maximum Sharpe ratio&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">min_vol_volatility</span><span class="p">,</span><span class="n">min_vol_return</span><span class="p">,</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">,</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="n">s</span><span class="o">=</span><span class="mi">400</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Minimum volatility&#39;</span><span class="p">)</span>

    <span class="n">target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">min_vol_return</span><span class="p">,</span> <span class="nb">max</span><span class="p">(</span><span class="n">an_rt</span><span class="p">),</span> <span class="mi">50</span><span class="p">)</span>
    <span class="n">efficient_portfolios</span> <span class="o">=</span> <span class="n">efficient_frontier</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span> <span class="n">covariance_matrix</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">p</span><span class="p">[</span><span class="s1">&#39;fun&#39;</span><span class="p">]</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">efficient_portfolios</span><span class="p">],</span> <span class="n">target</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;white&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;efficient frontier&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Calculated Portfolio Optimization based on Efficient Frontier&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Volatility&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Returns&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">labelspacing</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>

<span class="n">display_efficient_frontier_selected</span><span class="p">(</span><span class="n">average_returns</span><span class="p">,</span><span class="n">covariance_matrix</span><span class="p">,</span><span class="n">risk_free_rate</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p><img alt="Code_3sKudlcKG6" src="..\img\efficient-frontier-for-balancing-portfolios\Code_3sKudlcKG6.png"></p>
<p>From the plot above, the stock with the highest risk is BHP, which accompanies the highest returns. This shows that if the investor is willing to take the risk than they will be rewarded with the higher return.</p>
<p>This concludes the 3 part series on Python in the finance industry, if there is any topics in particular you would like to see how software can integrate and improve a service/product please feel free to get in touch!</p>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>