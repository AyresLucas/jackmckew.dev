<!DOCTYPE html>
<html lang="english">
<head>
          <title>Jack McKew's Blog - Intro to Web Scraping</title>
        <meta charset="utf-8" />




    <meta name="tags" content="python" />

</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https://jackmckew.dev/">Jack McKew's Blog <strong>Python enthusiast, electrical engineer and tinkerer</strong></a></h1>
        </header><!-- /#banner -->
        <nav id="menu"><ul>
            <li><a href="/archives.html">Archives</a></li>
            <li><a href="/categories.html">Categories</a></li>
            <li><a href="/tags.html">Tags</a></li>
            <li><a href="/sitemap.xml">Sitemap</a></li>
            <li><a href="https://jackmckew.dev/pages/contact.html">Contact</a></li>
            <li><a href="https://jackmckew.dev/pages/cv-professional.html">CV/Professional</a></li>
            <li><a href="https://jackmckew.dev/category/android.html">Android</a></li>
            <li><a href="https://jackmckew.dev/category/book-reviews.html">Book Reviews</a></li>
            <li><a href="https://jackmckew.dev/category/data-science.html">Data Science</a></li>
            <li><a href="https://jackmckew.dev/category/engineering.html">Engineering</a></li>
            <li><a href="https://jackmckew.dev/category/engineering-python.html">Engineering, Python</a></li>
            <li><a href="https://jackmckew.dev/category/machine-learning.html">Machine Learning</a></li>
            <li><a href="https://jackmckew.dev/category/principles.html">Principles</a></li>
            <li class="active"><a href="https://jackmckew.dev/category/python.html">Python</a></li>
            <li><a href="https://jackmckew.dev/category/python-data-science.html">Python, Data Science</a></li>
            <li><a href="https://jackmckew.dev/category/python-engineering.html">Python, Engineering</a></li>
            <li><a href="https://jackmckew.dev/category/python-principles.html">Python, Principles</a></li>
            <li><a href="https://jackmckew.dev/category/software-development.html">Software Development</a></li>
            <li><a href="https://jackmckew.dev/category/software-development-data-science.html">Software Development, Data Science</a></li>
        </ul></nav><!-- /#menu -->
<section id="content" class="body">
  <header>
    <h2 class="entry-title">
      <a href="https://jackmckew.dev/intro-to-web-scraping.html" rel="bookmark"
         title="Permalink to Intro to Web Scraping">Intro to Web Scraping</a></h2>
 
  </header>
  <footer class="post-info">
    <time class="published" datetime="2019-08-23T06:30:00+10:00">
      Fri 23 August 2019
    </time>
    <address class="vcard author">
      By           <a class="url fn" href="https://jackmckew.dev/author/jack-mckew.html">Jack McKew</a>
    </address>
    <div class="category">
        Category: <a href="https://jackmckew.dev/category/python.html">Python</a>
    </div>
    <div class="tags">
        Tags:
            <a href="https://jackmckew.dev/tag/python.html">python</a>
    </div>
  </footer><!-- /.post-info -->
  <div class="entry-content">
    <p>Following on from last weeks post where we analysed the amount of <a href="https://jmckew.com/2019/08/16/looking-for-patterns-in-city-names-interactive-plotting/">repeated letters within current New Zealand town names</a>. There was still one part of that analysis that really bugged me, and if you noticed it was from the data set that was used was using the European town names not the original Maori names. This post will be dedicated to introducing web scraping where we will extract the Maori names and run a similar analysis to present an interactive graph.</p>
<p>As like previously, let's take a look at the interactive graph before getting into how it was created.</p>
<p>{% notebook intro-to-web-scraping/scraping_analysis.ipynb cells[-1:] %}</p>
<p>Similarly with most of my posts of this nature, we always begin by getting the data. To find a data set that gives us as many Maori town or place names as possible proved to be quite challenging, but luckily for Maori Language week NZhistory.gov.nz posted a table of a 1000 Maori place names, their components and the meaning. This data can be found: <a href="https://nzhistory.govt.nz/culture/maori-language-week/1000-maori-place-names">https://nzhistory.govt.nz/culture/maori-language-week/1000-maori-place-names</a>.</p>
<p>Unlike last time however with our world city names from <a href="https://www.kaggle.com/">Kaggle</a>, this data isn't nicely supplied to us in an Excel format. While it may be possible to directly copy-paste from the website into a spreadsheet, I think this is a great way to ease into web scraping.</p>
<h2>What is Web Scraping?</h2>
<p>Web scraping, web harvesting or web data extraction is the process of extracting data from websites. To do this in Python, while there is multiple ways to achieve this (requests + beautiful soup, selenium, etc), my personal favourite package to use is <a href="https://scrapy.org/">Scrapy</a>. While it may be daunting to begin with from a non object-oriented basis, you will soon appreciate it more once you've begun using it.</p>
<p>Initially the premise around the <a href="https://scrapy.org/">Scrapy</a> package is to create 'web spiders'. If we take a look of the structure of the first example on the <a href="https://scrapy.org/">Scrapy</a> website we get an understanding on how to structure our web spiders when developing:</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">scrapy</span>

<span class="k">class</span> <span class="nc">BlogSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;blogspider&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://blog.scrapinghub.com&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">title</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;.post-header&gt;h2&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">title</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;a ::text&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()}</span>
        <span class="k">for</span> <span class="n">next_page</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">css</span><span class="p">(</span><span class="s1">&#39;a.next-posts-link&#39;</span><span class="p">):</span>
            <span class="k">yield</span> <span class="n">response</span><span class="o">.</span><span class="n">follow</span><span class="p">(</span><span class="n">next_page</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse</span><span class="p">)</span>
</pre></div>
</td></tr></table>

<p>First of all we can see that the custom spider is essentially an extension of the scrapy.Spider class. It is to be noted that the name and start_urls variables (which are apart of the class) are special in the sense the scrapy package uses them as configuration settings. When it comes to web scraping, if you have had experience using HTML, CSS and/or Javascript, this experience will become extremely useful; that is not to say it is not possible without experience, it's just a learning curve.</p>
<p>Following on we can see a function for parsing (also specially named) in which there are 2 loops, the first for loop is going to loop through all title's marked as headers (specifically h2) and return a dictionary with the text in the heading.</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">NameSpider</span><span class="p">(</span><span class="n">scrapy</span><span class="o">.</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;names&#39;</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://nzhistory.govt.nz/culture/maori-language-week/1000-maori-place-names/&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">response</span><span class="p">):</span>
        <span class="k">def</span> <span class="nf">extract_from_table</span><span class="p">(</span><span class="n">table_row</span><span class="p">,</span><span class="n">table_col</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">response</span><span class="o">.</span><span class="n">xpath</span><span class="p">(</span><span class="n">f</span><span class="s2">&quot;//tr[{table_row}]//td[{table_col}]//text()&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">1000</span><span class="p">):</span>
            <span class="k">yield</span> <span class="p">{</span>
                <span class="s1">&#39;Place Name&#39;</span> <span class="p">:</span> <span class="n">extract_from_table</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">1</span><span class="p">),</span>
                <span class="s1">&#39;Components&#39;</span> <span class="p">:</span> <span class="n">extract_from_table</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">),</span>
                <span class="s1">&#39;Meaning&#39;</span> <span class="p">:</span> <span class="n">extract_from_table</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="mi">3</span><span class="p">)</span>
            <span class="p">}</span>
</pre></div>
</td></tr></table>

<p>Now that we have created our spider that looks through each row of the table on the webpage (more information on determining this can be found: <a href="https://docs.scrapy.org/en/latest/intro/tutorial.html">https://docs.scrapy.org/en/latest/intro/tutorial.html</a>). It's time to run the spider and take a look at the output. To run a spider you go into the directory from the command line and run 'scrapy crawl \&lt;spider name>' and to store an output at the same time 'scrapy crawl \&lt;spider name> -o filename.csv -t csv.</p>
<p>Now similar to the previous post, we run a similar analysis and plot with Bokeh!</p>
<table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="kn">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">collections</span>
<span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="kn">import</span> <span class="nn">operator</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="kn">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="kn">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">from</span> <span class="nn">bokeh.io</span> <span class="kn">import</span> <span class="n">show</span><span class="p">,</span> <span class="n">output_file</span>
<span class="kn">from</span> <span class="nn">bokeh.plotting</span> <span class="kn">import</span> <span class="n">figure</span>
<span class="kn">from</span> <span class="nn">bokeh.models</span> <span class="kn">import</span> <span class="n">ColumnDataSource</span>
<span class="kn">from</span> <span class="nn">bokeh.models.tools</span> <span class="kn">import</span> <span class="n">HoverTool</span>

<span class="n">names_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;names.csv&#39;</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s1">&#39;,&#39;</span><span class="p">,</span> <span class="n">quotechar</span><span class="o">=</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span>
<span class="n">nz_names</span> <span class="o">=</span> <span class="n">names_df</span><span class="p">[</span><span class="s1">&#39;Place Name&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">nz_dict</span> <span class="o">=</span> <span class="p">{</span> <span class="n">i</span> <span class="p">:</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">nz_names</span> <span class="p">}</span>
<span class="n">letters</span> <span class="o">=</span> <span class="s1">&#39;ABCDEFGHIJKLMNOPQRSTUVWXYZ&#39;</span>
<span class="n">lcount</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">]))</span>

<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">nz_names</span><span class="p">:</span>
    <span class="n">nz_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">]))</span>
    <span class="n">city_dict</span> <span class="o">=</span> <span class="n">nz_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">name</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">:</span>
            <span class="n">city_dict</span><span class="p">[</span><span class="n">c</span><span class="o">.</span><span class="n">upper</span><span class="p">()]</span> <span class="o">+=</span> <span class="mi">1</span>

<span class="n">total_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="o">.</span><span class="n">from_dict</span><span class="p">(</span><span class="n">nz_dict</span><span class="p">)</span>
<span class="n">total_df</span> <span class="o">=</span> <span class="n">total_df</span><span class="o">.</span><span class="n">T</span>

<span class="n">max_letters_cities</span> <span class="o">=</span> <span class="n">total_df</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">lettercounts</span> <span class="o">=</span> <span class="n">total_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">total_df</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">maxletters</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">OrderedDict</span><span class="p">([(</span><span class="n">l</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">letters</span><span class="p">]))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">letters</span><span class="p">):</span>
    <span class="n">maxletters</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="n">max_letters_cities</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    <span class="n">maxletters</span><span class="p">[</span><span class="n">l</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">lettercounts</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>

<span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
<span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;Word_Name&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_df</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()</span>
<span class="n">summary_df</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">total_df</span><span class="o">.</span><span class="n">idxmax</span><span class="p">()]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

<span class="n">source</span> <span class="o">=</span> <span class="n">ColumnDataSource</span><span class="p">(</span><span class="n">summary_df</span><span class="p">)</span>
<span class="n">output_file</span><span class="p">(</span><span class="s2">&quot;letter_count.html&quot;</span><span class="p">)</span>

<span class="n">hover</span> <span class="o">=</span> <span class="n">HoverTool</span><span class="p">()</span>
<span class="n">hover</span><span class="o">.</span><span class="n">tooltips</span><span class="o">=</span><span class="p">[</span>
    <span class="p">(</span><span class="s1">&#39;Word&#39;</span><span class="p">,</span> <span class="s1">&#39;@Word&#39;</span><span class="p">)</span>
<span class="p">]</span>

<span class="n">p</span> <span class="o">=</span> <span class="n">figure</span><span class="p">(</span><span class="n">x_range</span><span class="o">=</span><span class="n">summary_df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">plot_height</span><span class="o">=</span><span class="mi">250</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">&quot;Letter Counts&quot;</span><span class="p">,</span>
           <span class="n">toolbar_location</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

<span class="n">p</span><span class="o">.</span><span class="n">vbar</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="s1">&#39;Count&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">add_tools</span><span class="p">(</span><span class="n">hover</span><span class="p">)</span>
<span class="n">p</span><span class="o">.</span><span class="n">xgrid</span><span class="o">.</span><span class="n">grid_line_color</span> <span class="o">=</span> <span class="bp">None</span>
<span class="n">p</span><span class="o">.</span><span class="n">y_range</span><span class="o">.</span><span class="n">start</span> <span class="o">=</span> <span class="mi">0</span>

<span class="n">show</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
</pre></div>
</td></tr></table>
  </div><!-- /.entry-content -->
</section>
        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>,
                which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->
        </footer><!-- /#contentinfo -->
</body>
</html>